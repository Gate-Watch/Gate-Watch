<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Métricas Gerente - GateWatch</title>
    <link rel="stylesheet" href="./CSS/styleRegressao.css">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>

<body>

    <div class="conteudoPagina">
        <div class="boxLateral">
            <div class="boxIdentificacao">
                <h1 class="fonte_perfil" id="nome_perfil">Usuário</h1>
                <h3>ANALISTA DE DADOS</h3>
            </div>
            <div class="boxOpcoes">
                <a href="index.html">
                    <div class="box">HOME</div>
                </a>
                <a href="dashboardAnalistaMetricas.html">
                    <div class="box">DASHBOARD</div>
                </a>
                <a href="dashboardAnalistaRegressao.html">
                    <div class="box" style="background-color: #41446877;">PREVISÕES</div>
                </a>
            </div>
            <a href="cadastro.html">
                <div class="boxSair">SAIR</div>
            </a>
        </div>
        <div class="conteudoMetricas">
            <div class="boxTitulo">
                <div class="selecionarTotem">
                    <select id="selectTotem" onchange="fetchMetrics()">
                        <option value="1" selected>Totem 1</option>
                        <option value="2">Totem 2</option>
                        <option value="3">Totem 3</option>
                    </select>
                    <select id="selectComp" onchange="fetchMetrics()">
                        <option value="Cpu" selected>CPU</option>
                        <option value="Ram">RAM</option>
                        <option value="Disco">DISCO</option>
                    </select>
                </div>
            </div>
            <div class="boxConteudo">
                <div class="boxComponentes">
                    <div class="ranking">
                        <h3>Ranking de Totens com Maiores Previsões na Semana Atual</h3>
                        <div class="ranking-grid" id="ranking">
                            <div class="ranking-posicao">1°</div>
                            <div class="ranking-nome">Carregando...</div>
                        </div>
                    </div>
                    <div class="boxMedias">
                        <div class="box1">
                            <h4>Dia com maior previsão</h4>
                            <p id="maiorPrevisao">Carregando...</p>
                        </div>
                        <div class="box2">
                            <h4>Dia com menor previsão</h4>
                            <p id="menorPrevisao">Carregando...</p>
                        </div>
                    </div>
                    <div class="boxGrafico">
                        <div class="grafico">
                            <div id="chart" style="margin-top: 0.3vh;"></div>
                        </div>
                    </div>
                </div>
                <div class="boxAlertas">
                    <div class="boxRankingAlertas"></div>
                    <div class="grafico2">
                        <div id="chart2" style="margin-top: 1.3vh;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>

<script>
    async function fetchMetrics() {
        const selectedTotem = document.getElementById('selectTotem').value;
        const selectedComponent = document.getElementById('selectComp').value;

        try {
            const response = await fetch(`/dashRegressao/semanal/${selectedTotem}/${selectedComponent}`);
            if (!response.ok) throw new Error('Erro ao buscar dados do servidor.');

            const data = await response.json();

            const diasSemanaIngles = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const diasSemanaPortugues = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];

            // Converte valores para as categorias em português (simplificadas)
            const valores = diasSemanaIngles.map(dia => data.find(item => item.dia_semana === dia)?.componente_avg || 0);

            // Dia com maior e menor previsão
            const maiorPrevisao = diasSemanaPortugues[valores.indexOf(Math.max(...valores))];
            const menorPrevisao = diasSemanaPortugues[valores.indexOf(Math.min(...valores))];

            document.getElementById('maiorPrevisao').textContent = maiorPrevisao;
            document.getElementById('menorPrevisao').textContent = menorPrevisao;

            renderChart1(diasSemanaPortugues, valores);
            renderChart2(diasSemanaPortugues, valores);

        } catch (error) {
            console.error('Erro ao buscar métricas:', error);
        }
    }

    function renderChart1(dias, valores) {
        const selectedComponent = document.getElementById('selectComp').value;
        const chartContainer = document.querySelector("#chart");
        chartContainer.innerHTML = ''; 

        const options = {
            chart: { type: 'line', height: 292 },
            series: [
                { name: `Componente: ${selectedComponent}`, data: valores }
            ],
            xaxis: {
                categories: dias,
                labels: { style: { colors: '#ffffff' } }
            },
            yaxis: {
                min: 0,
                max: 100,
                labels: { style: { colors: '#ffffff' } }
            },
            stroke: {
                curve: 'smooth',
                width: 4
            },
            annotations: {
                yaxis: [
                    {
                        y: 65,
                        borderColor: '#00ff00',
                        label: {
                            borderColor: '#00ff00',
                            style: {
                                color: '#000000',
                                background: '#00ff00',
                                fontSize: '10px'
                            },
                            text: 'Limite (65%)'
                        },
                        strokeDashArray: 7 
                    }
                ]
            },
            colors: ['#18204b'],
            title: {
                text: `Previsão do Percentual Máximo e Mínimo de ${selectedComponent}`,
                align: 'left',
                style: { color: '#ffffff', fontSize: '17px' }
            },
            legend: {
                labels: { colors: '#ffffff' },
                position: 'bottom'
            }
        };

        const chart = new ApexCharts(chartContainer, options);
        chart.render();
    }

    function renderChart2(dias, valores) {
        const selectedComponent = document.getElementById('selectComp').value;
        const chartContainer2 = document.querySelector("#chart2");
        chartContainer2.innerHTML = ''; 

        const options = {
            chart: { type: 'line', height: 295, width: 470 },
            series: [
                { name: `Componente: ${selectedComponent}`, data: valores }
            ],
            xaxis: {
                categories: dias,
                labels: {
                    style: { colors: '#ffffff' },
                    rotate: -45, // Rotação para evitar sobreposição
                    hideOverlappingLabels: false // Força mostrar todos os rótulos
                }
            },
            yaxis: {
                min: 0,
                max: 100,
                labels: { style: { colors: '#ffffff' } }
            },
            stroke: {
                curve: 'smooth',
                width: 4
            },
            annotations: {
                yaxis: [
                    {
                        y: 65,
                        borderColor: '#00ff00',
                        label: {
                            borderColor: '#00ff00',
                            style: {
                                color: '#000000',
                                background: '#00ff00',
                                fontSize: '10px'
                            },
                            text: 'Limite (65%)'
                        },
                        strokeDashArray: 7 
                    }
                ]
            },
            colors: ['#18204b'],
            title: {
                text: `Previsão do Percentual de ${selectedComponent}`,
                align: 'left',
                style: { color: '#ffffff', fontSize: '17px' }
            },
            legend: {
                labels: { colors: '#ffffff' },
                position: 'bottom'
            }
        };

        const chart2 = new ApexCharts(chartContainer2, options);
        chart2.render();
    }

    document.addEventListener("DOMContentLoaded", fetchMetrics);
</script>


</html>