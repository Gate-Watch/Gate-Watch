<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Métricas Gerente - GateWatch</title>
    <link rel="stylesheet" href="./CSS/styleRegressao.css">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>

<body>

    <div class="conteudoPagina">
        <div class="boxLateral">
            <div class="boxIdentificacao">
                <h1 class="fonte_perfil" id="nome_perfil"></h1>
                <h3>ANALISTA DE DADOS</h3>
            </div>
            <div class="boxOpcoes">
                <a href="index.html">
                    <div class="box">HOME</div>
                </a>
                <a href="dashboardAnalistaMetricas.html">
                    <div class="box">DASHBOARD</div>
                </a>
                <a href="dashboardAnalistaRegressao.html">
                    <div class="box" style="background-color: #41446877;">PREVISÕES</div>
                </a>
            </div>
            <a href="cadastro.html">
                <div class="boxSair">SAIR</div>
            </a>
        </div>
        <div class="conteudoMetricas">
            <div class="boxTitulo">
                <div class="selecionarTotem">
                    <select id="selectTotem" onchange="fetchMetrics()">
                        <option selected disabled>Selecione um Totem</option>
                        <option>TOTEM 1</option>
                        <option>TOTEM 2</option>
                        <option>TOTEM 3</option>
                    </select>
                    <select id="selectSemana" onchange="fetchMetrics()">
                        <option selected disabled>Selecione a Semana</option>
                        <option>SEMANA 1</option>
                        <option>SEMANA 2</option>
                        <option>SEMANA 3</option>
                        <option>SEMANA 4</option>
                        <option>SEMANA 5</option>
                    </select>
                    <select id="selectComp" onchange="fetchMetrics()">
                        <option selected disabled>Selecione um Componente</option>
                        <option>CPU</option>
                        <option>RAM</option>
                        <option>DISCO</option>
                    </select>
                </div>
            </div>
            <div class="boxConteudo">
                <div class="boxComponentes">
                    <div class="ranking">
                        <h3>Ranking de Semanas com Maiores Previsões</h3>
                        <div class="ranking-grid">
                            <div class="ranking-posicao">1°</div>
                            <div class="ranking-nome">Totem 1 - Semana 3</div>
                            <div class="ranking-posicao">2°</div>
                            <div class="ranking-nome">Totem 1 - Semana 1</div>
                            <div class="ranking-posicao">3°</div>
                            <div class="ranking-nome">Totem 1 - Semana 4</div>
                        </div>
                    </div>
                    <div class="boxMedias">
                        <div class="box1">
                            <h4>Dia com maior previsão</h4>
                            <p>Quarta</p>
                        </div>
                        <div class="box2">
                            <h4>Dia com menor previsão</h4>
                            <p>Terça</p>
                        </div>
                    </div>
                    <div class="boxGrafico">
                        <div class="grafico">
                            <div id="chart"></div>
                        </div>
                    </div>
                </div>
                <div class="boxAlertas">
                    <div class="boxRankingAlertas">

                    </div>
                    <div class="grafico2">
                        <div id="chart2" style="margin-top: 0.8vh;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>

</html>

<script>
    async function fetchMetrics() {
        try {
            const selectedTotem = document.getElementById('selectTotem').value;
            const selectedSemana = document.getElementById('selectSemana').value;
            const selectedComponent = document.getElementById('selectComp').value;

            if (!selectedTotem || !selectedSemana || !selectedComponent) {
                alert('Por favor, selecione um Totem, Semana e Componente.');
                return;
            }

            const response = await fetch(`/dashRegressao/semanal?totem=${selectedTotem}&semana=${selectedSemana}&component=${selectedComponent}`);
            if (!response.ok) {
                const errorText = await response.text();
                console.error("Erro do servidor:", errorText);
                throw new Error('Erro ao buscar dados do servidor.');
            }

            const data = await response.json();
            console.log("Dados recebidos do servidor:", data);

            const { dias, previsoesAtuais, previsoesMin, previsoesMax } = data;

            if (!dias || !previsoesAtuais || !previsoesMin || !previsoesMax) {
                alert('Dados insuficientes recebidos do servidor.');
                return;
            }

            renderChart1(dias, previsoesAtuais, previsoesMin, previsoesMax);

        } catch (error) {
            console.error("Erro ao buscar métricas semanais:", error);
            alert('Erro ao buscar dados do servidor. Verifique os logs para mais detalhes.');
        }
    }

    function renderChart1(dias, previsoesAtuais, previsoesMin, previsoesMax) {
        const chartContainer = document.querySelector("#chart");
        if (chartContainer.children.length) {
            chartContainer.innerHTML = '';
        }

        const options = {
            chart: {
                type: 'line',
                height: 290,
            },
            series: [
                { name: 'Métrica Atual', data: previsoesAtuais },
                { name: 'Previsão Máxima', data: previsoesMax },
                { name: 'Previsão Mínima', data: previsoesMin },
            ],
            xaxis: { categories: dias, labels: { style: { colors: '#ffffff' } } },
            yaxis: { min: 0, max: 100, labels: { style: { colors: '#ffffff' } } },
            stroke: { curve: 'smooth', width: [4, 3, 3] },
            colors: ['#1e81b0', '#ff0000', '#00ff00'],
            title: { text: 'Previsão do Percentual', align: 'left', style: { color: '#ffffff', fontSize: '17px' } },
            legend: { labels: { colors: '#ffffff' }, position: 'bottom' },
        };

        const chart = new ApexCharts(chartContainer, options);
        chart.render();
    }


    function renderChart2(dias, componentData) {
        // Destruir gráfico anterior, se existir
        const chartContainer2 = document.querySelector("#chart2");
        if (chartContainer2.children.length) {
            chartContainer2.innerHTML = '';
        }

        const options = {
            chart: {
                type: 'line',
                height: 295,
                width: 470
            },
            series: [
                { name: 'Componente Escolhido', data: componentData },
                { name: 'Limite Componente', data: Array(dias.length).fill(65) }
            ],
            xaxis: { categories: dias, labels: { style: { colors: '#ffffff' } } },
            yaxis: { min: 0, max: 100, labels: { style: { colors: '#ffffff' } } },
            stroke: { curve: 'smooth', width: [4, 3], dashArray: [0, 5] },
            colors: ['#1e81b0', '#00FF00'],
            title: { text: 'Previsão do Percentual', align: 'left', style: { color: '#ffffff', fontSize: '17px' } },
            legend: { labels: { colors: '#ffffff' }, position: 'bottom' }
        };

        const chart2 = new ApexCharts(chartContainer2, options);
        chart2.render();
    }

    // Carregar gráficos com valores padrão ao carregar a página
    document.addEventListener("DOMContentLoaded", () => {
        document.getElementById('selectComp').value = "CPU";
        document.getElementById('selectTotem').value = "TOTEM 1";
        document.getElementById('selectSemana').value = "SEMANA 2";
        fetchMetrics();
    });


</script>