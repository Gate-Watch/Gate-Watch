<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cadastro-GateWatch</title>
  <link rel="shortcut icon" type="image/png" href="../Images/gwLogo_white.png">
  <link rel="stylesheet" href="./CSS/style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css">
  <!-- <meta http-equiv="refresh" content="3" /> -->
  <meta name="keywords" content="navbar, responsive, HTML, CSS, JavaScript, nav" />
  <meta name="author" content="Manikanta Vedula" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="../JavaScript/sessao.js"></script>
</head>

<body>
  <nav class="navbar">
    <div class="menu-icon">
      <span></span>
      <span></span>
      <span></span>
    </div>

    <div class="logo">
      <img class="logoImg" src="Images/gwLogo_white.png" alt="">
    </div>

    <ul class="nav-links">
      <li><a href="index.html">Home</a></li>
      <li><a href="sobre.html">Sobre Nós</a></li>
      <li><a href="cadastro.html">Cadastro</a></li>
    </ul>
  </nav>

  <div class="cad_espaco"></div>

  <div class="cad_container painel-direito-ativo">
    <!-- Sign Up -->
    <div class="cad_container__form cad_container--logIn">
      <form action="#" class="form" id="form1">
        <h2 class="cad_form__title">Cadastre-se</h2>
        <select name="cargo" id="inp_cargo" class="cad_slct">
          <option value="#">Cargo</option>
          <option value="Analista">Analista</option>
          <option value="Gerente">Gerente</option>
        </select>
        <input id="nomeCadastro_input" class="cad_inp" type="text" placeholder="Nome">
        <input id="emailCadastro_input" class="cad_inp" type="email" placeholder="Email">
        <input id="codSegCadastro_input" class="cad_inp" type="text" placeholder="Código de segurança">
        <input id="senhaCadastro_input" class="cad_inp" type="password" placeholder="Senha">
        <input id="confirmaSenhaCadastro_input" class="cad_inp" type="password" placeholder="Repita a Senha">
        <button type="button" class="cad_btn" onclick="cadastrar()">Cadastrar</button>
      </form>
    </div>


    <!-- Sign In -->
    <div class="cad_container__form cad_container--cadastro">
      <form action="#" class="form" id="form2">
        <h2 class="cad_form__title">Logar</h2>
        <input id="emailLogin_input" type="email" placeholder="Email" class="cad_inp" />
        <input id="senhaLogin_input" type="password" placeholder="Senha" class="cad_inp" />
        <a href="#" class="cad_link">Esqueceu sua senha?</a>
        <button onclick="entrar()" class="cad_btn">Login</button>
      </form>
    </div>

    <!-- Error and Loading Cards -->
    <div class="card_erro" id="cardErro" style="display: none; text-align: center; color: red;">
      <span id="mensagem_erro"></span>
    </div>
    <div class="card_aguardar" id="div_aguardar" style="display: none; text-align: center; color: blue;">
      <span>Aguarde...</span>
    </div>

    <!-- cad_sobreposicao -->
    <div class="cad_container__cad_sobreposicao">
      <div class="cad_sobreposicao">
        <div class="cad_sobreposicao__panel cad_sobreposicao--esquerdo">
          <h5>Já possui login?</h5>
          <button class="cad_btn" id="login">Login</button>
        </div>
        <div class="cad_sobreposicao__panel cad_sobreposicao--right">
          <h5>Ainda não possui Login?</h5>
          <button class="cad_btn" id="cadastro">Cadastrar</button>
        </div>
      </div>
    </div>
  </div>

  <div class="cad_espaco"></div>

  <!-- Footer Start -->
   <section class="foot">
  <div class="footer">
    <div class="container">
      <div class="row">
        <div class="col-md-6">
          <div class="footer-about">
            <h3>Sobre nós</h3>
            <p>
              A GateWatch é uma empresa líder em soluções de monitoramento de sistemas críticos, voltada para o setor de aviação. Com um foco em inovação e eficiência, nossa missão é garantir que nossos clientes operem de forma contínua, minimizando qualquer risco de interrupção. Trabalhamos lado a lado com nossos parceiros para oferecer soluções personalizadas e de alto impacto, sempre priorizando a qualidade e a satisfação do cliente. Nosso time é formado por especialistas altamente capacitados, comprometidos em oferecer o melhor serviço e suporte técnico.
            </p>
          </div>
        </div>
        <div class="col-md-6">
          <div class="footer-contact">
            <h3>Entre em Contato</h3>
            <p><i class="fa fa-map-marker-alt"></i>Rua Haddock Lobo, 545</p>
            <p><i class="fa fa-phone-alt"></i>+55 11 99999-9999</p>
            <p><i class="fa fa-envelope"></i>gatewatch@outlook.com</p>
            <p><i class="fa fa-clock"></i>8:00 | 20:00</p>
          </div>
        </div>
      </div>
    </div>
    
    <div class="container copyright">
      <div class="row">
        <p>&copy; <a href="index.html">GateWatch</a>, Todos os direitos reservados.</p>
      </div>
    </div>
  </div>
  </div>
  <!-- Footer End -->
</section>
</body>

</html>


<style>
  :root {
    /* COLORS */
    --white: #e9e9e9;
    --gray: #333;
    --blue: #0367a6;
    --lightblue: #008997;

    /* RADII */
    --button-radius: 0.7rem;

    /* SIZES */
    --max-width: 1080px;
    --max-height: 600px;

  }

  body {
    align-items: center;
    background-color: var(--white);
    display: grid;
    place-items: center;
  }

</style>

<script>
  const logincad_Btn = document.getElementById("login");
  const cadastrocad_Btn = document.getElementById("cadastro");
  const Form1 = document.getElementById("form1");
  const Form2 = document.getElementById("form2");
  const cad_container = document.querySelector(".cad_container");

  logincad_Btn.addEventListener("click", () => {
    cad_container.classList.remove("painel-direito-ativo");
  });

  cadastrocad_Btn.addEventListener("click", () => {
    cad_container.classList.add("painel-direito-ativo");
  });

  Form1.addEventListener("submit", (e) => e.preventDefault());
  Form2.addEventListener("submit", (e) => e.preventDefault());

  //Header
  const menuSlide = () => {
    const menuIcon = document.querySelector(".menu-icon");
    const navLinks = document.querySelector(".nav-links");
    const navLinksInner = document.querySelectorAll(".nav-links li");

    //menu-icon click event
    menuIcon.addEventListener("click", () => {
      //toggle active class
      navLinks.classList.toggle("menu-active");

      //animate navLinks
      navLinksInner.forEach((li, index) => {
        if (li.style.animation) {
          li.style.animation = "";
        } else {
          li.style.animation = `navLinkAnime 0.5s ease forwards ${index / 7 + 0.3
            }s`;
        }
      });

      //toggle for menu-icon animation
      menuIcon.classList.toggle("span-anime");
    });
  };

  menuSlide();

  async function cadastrar() {
    var nomeVar = document.getElementById('nomeCadastro_input').value;
    var emailVar = document.getElementById('emailCadastro_input').value;
    var codSegVar = document.getElementById('codSegCadastro_input').value;
    var senhaVar = document.getElementById('senhaCadastro_input').value;
    var confirmacaoSenhaVar = document.getElementById('confirmaSenhaCadastro_input').value;
    var cargoVar = document.getElementById('inp_cargo').value;

    if (
      nomeVar === "" || emailVar === "" || codSegVar === "" || senhaVar === "" ||
      confirmacaoSenhaVar === "" || cargoVar === "#" || cargoVar === ""
    ) {
      mostrarErro("Todos os campos devem ser preenchidos.");
      return false;
    } else if (nomeVar.length <= 1) {
      mostrarErro("O nome é muito curto.");
      return false;
    } else if (emailVar.indexOf("@") < 0 || emailVar.indexOf(".") < 0) {
      mostrarErro("O email não é válido.");
      return false;
    } else if (senhaVar !== confirmacaoSenhaVar) {
      mostrarErro("As senhas não coincidem.");
      return false;
    } else {
      document.getElementById('div_aguardar').style.display = "block";
    }

    try {
      const idEmpresa = await verificarCodigoSeguranca(codSegVar);

      if (!idEmpresa) {
        mostrarErro("Código de segurança inválido.");
        return false;
      }

      const response = await fetch("/usuario/cadastrar", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          nomeServer: nomeVar,
          emailServer: emailVar,
          codSegServer: codSegVar,
          senhaServer: senhaVar,
          cargoServer: cargoVar
        }),
      });

      if (response.ok) {
        document.getElementById('div_aguardar').style.display = "none";
        mostrarSucesso("Cadastro realizado com sucesso! Redirecionando para tela de Login...");

        // Ao invés de redirecionar, adicionar a classe que ativa o painel de login
        setTimeout(() => {
          cad_container.classList.remove('painel-direito-ativo');  // Alterna para a tela de login
        }, 2000);

      } else {
        const erroTexto = await response.text();
        throw new Error(erroTexto);
      }
    } catch (erro) {
      console.log(`#ERRO: ${erro}`);
      mostrarErro(erro.message);
    }
  }


  function mostrarErro(mensagem) {
    document.getElementById('cardErro').style.display = "block";
    document.getElementById('mensagem_erro').innerHTML = mensagem;
    sumirMensagem();
  }

  function mostrarSucesso(mensagem) {
    document.getElementById('cardErro').style.display = "block";
    document.getElementById('mensagem_erro').style.color = "green";
    document.getElementById('mensagem_erro').innerHTML = mensagem;
  }

  function sumirMensagem() {
    setTimeout(() => {
      document.getElementById('cardErro').style.display = "none";
      document.getElementById('mensagem_erro').innerHTML = "";
      document.getElementById('mensagem_erro').style.color = "red";
    }, 5000);
  }

  async function verificarCodigoSeguranca(codSegVar, cargoVar) {
  try {
    const response = await fetch('/usuario/verificarCodigoSeguranca', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ codSeg: codSegVar, cargo: cargoVar }),
    });

    if (response.ok) {
      const data = await response.json();
      console.log('Resposta do servidor:', data);
      return data.idCompanhia; // Retorna a companhia se o código for válido
    } else {
      return null;
    }
  } catch (error) {
    console.error('Erro ao verificar o código de segurança:', error);
    return null;
  }
}

  // Funcao login 
  function entrar() {
    aguardar();

    var emailVar = document.getElementById("emailLogin_input").value;
    var senhaVar = document.getElementById("senhaLogin_input").value;

    if (emailVar == "" || senhaVar == "") {
      cardErro.style.display = "block";
      mensagem_erro.innerHTML = "Preencha todos os campos!";
      finalizarAguardar();
      return false;
    } else {
      setInterval(sumirMensagem, 3000);
    }

    fetch("/usuario/autenticar", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        emailServer: emailVar,
        senhaServer: senhaVar
      })
    }).then(function (resposta) {
      if (resposta.ok) {
        resposta.json().then(json => {
          sessionStorage.ID_USUARIO = json.id;
          sessionStorage.EMAIL_USUARIO = json.email;
          sessionStorage.NOME_USUARIO = json.nome;
          sessionStorage.CARGO_USUARIO = json.cargo;

          // Redirecionar com base no cargo do usuário
          if (json.cargo === 'analista') {
            window.location = "./dashboard1.html";
          } if (json.cargo === 'gerente') {
            window.location = "./dashboard2.html";
          }
        });

      } else {
        resposta.text().then(texto => {
          console.error(texto);
          finalizarAguardar(texto);
        });
      }
    }).catch(function (erro) {
      console.log(erro);
    });

    return false;
  }

</script>