<!DOCTYPE html>
<html lang="pt-br">

<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Métricas Gerente - GateWatch</title>
   <link rel="stylesheet" href="./CSS/styleRegressao.css">
   <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
   <script src="https://cdn.jsdelivr.net/npm/regression"></script>
</head>

<body>

   <div class="conteudoPagina">
       <div class="boxLateral">
           <div class="boxIdentificacao">
               <h1 class="fonte_perfil" id="nome_perfil">Usuário</h1>
               <h3>ANALISTA DE DADOS</h3>
           </div>
           <div class="boxOpcoes">
               <a href="index.html">
                   <div class="box">HOME</div>
               </a>
               <a href="DashboardAnalistaCerejo.html">
                   <div class="box">DASHBOARD</div>
               </a>
               <a href="dashboardAnalistaRegressao.html">
                   <div class="box" style="background-color: #41446877;">PREVISÕES</div>
               </a>
           </div>
           <a href="cadastro.html">
               <div class="boxSair">SAIR</div>
           </a>
       </div>
       <div class="conteudoMetricas">
           <div class="boxTitulo">
               <h2 class="tituloDash">Previsão das Métricas dos Componentes</h3>
                   <div class="selecionarTotem">
                       <select id="selectTotem" onchange="fetchMetrics()">
                           <option value="1" selected>Totem 1</option>
                           <option value="2">Totem 2</option>
                           <option value="3">Totem 3</option>
                       </select>
                       <select id="selectComp" onchange="fetchMetrics()">
                           <option value="Cpu" selected>CPU</option>
                           <option value="Ram">RAM</option>
                           <option value="Disco">DISCO</option>
                       </select>
                       <!-- <button id="openModal" class="modal-button">Abrir Modal</button> -->
                   </div>
                   <img src="Images/gwLogo_black.png" alt="" style="height: 7.5vh; width: 3.5vw; margin-left: 0.6vw;">
           </div>
           <div class="boxConteudo">
               <div class="boxComponentes">
                   <div class="ranking">
                       <h3>Ranking das Maiores Métricas de cada Componente entre os Totens</h3>
                       <div class="ranking-grid" id="ranking">
                           <div id="posicao1" class="ranking-posicao"></div>
                           <div id="nome1" class="ranking-nome"></div>
                           <div id="posicao2" class="ranking-posicao"></div>
                           <div id="nome2" class="ranking-nome"></div>
                           <div id="posicao3" class="ranking-posicao"></div>
                           <div id="nome3" class="ranking-nome"></div>
                       </div>

                   </div>
                   <div class="boxMedias">
                       <div class="box1">
                           <h4>Dia com maior previsão</h4>
                           <p id="maiorPrevisao">Carregando...</p>
                       </div>
                       <div class="box2">
                           <h4>Dia com menor previsão</h4>
                           <p id="menorPrevisao">Carregando...</p>
                       </div>
                   </div>
                   <div class="boxGrafico">
                       <div class="grafico">
                           <div id="chart" style="margin-top: 0vh;"></div>
                       </div>
                   </div>
               </div>
               <div class="boxAlertas">
                   <div class="boxRankingAlertas">
                       <h3 style="text-align: center; margin-top: -0.8vh;">Dias com Métrica Acima e Abaixo da Previsão
                       </h3>
                       <div class="linha-central"></div> <!-- Linha centralizada -->
                       <div class="conteudo-ranking" style="margin-top: -4.5vh;">
                           <div class="acima">
                               <h4>Dias Acima:</h4>
                               <ul id="diasAcima" style="margin-right: 3.7vw; margin-top: 0.5vh"></ul>
                           </div>
                           <div class="abaixo">
                               <h4>Dias Abaixo:</h4>
                               <ul id="diasAbaixo" style="margin-right: 1.8vw; margin-top: 0.5vh;"></ul>
                           </div>
                       </div>
                   </div>
                   <div class="grafico2">
                       <div id="chart2" style="margin-top: 1vh;"></div>
                   </div>
               </div>
           </div>
       </div>
   </div>
   <div class="overlay" style="display: none;">
       <div class="modal">
           <button class="close-button">
               <span class="X"></span>
               <span class="Y"></span>
               <div class="close">Sair</div>
           </button>
           <h2 id="modal-title">Detalhes do Dia</h2>
           <p id="modal-content">Carregando informações...</p>

           <!-- Botão de Select -->
           <label for="select-dia">Escolha outro dia:</label>
           <select id="select-dia" onchange="atualizarDiaSelecionado(this.value)">
               <option value="Sunday">Domingo</option>
               <option value="Monday">Segunda</option>
               <option value="Tuesday">Terça</option>
               <option value="Wednesday">Quarta</option>
               <option value="Thursday">Quinta</option>
               <option value="Friday">Sexta</option>
               <option value="Saturday">Sábado</option>
           </select>

           <!-- Container para o Gráfico -->
           <div id="modal-chart" style="height: 300px;"></div>
       </div>
   </div>

</body>

<script>
   nome_perfil.innerHTML = sessionStorage.NOME_USUARIO;

   let diaAtual; // Variável global para armazenar o dia atual

   function abrirModal(conteudo, diaInicial) {
       const modal = document.querySelector('.overlay');
       const modalConteudo = document.querySelector('#modal-content');
       const selectDia = document.getElementById('select-dia');

       // Atualiza o conteúdo do modal e o select com o dia inicial
       modalConteudo.textContent = conteudo;
       selectDia.value = diaInicial;

       // Salva o dia inicial na variável global e no sessionStorage
       diaAtual = diaInicial;
       sessionStorage.setItem('DIA_ATUAL', diaInicial);

       // Renderiza o gráfico inicial
       carregarGraficoDia(diaInicial);

       // Exibe o modal
       modal.style.display = 'flex';
   }

   function configurarModal() {
   const modal = document.querySelector('.overlay');
   const closeButton = document.querySelector('.close-button');

   // Fechar o modal ao clicar no botão de fechar
   closeButton.addEventListener('click', () => {
       modal.style.display = 'none';
   });

   // Fechar o modal ao clicar fora do conteúdo
   modal.addEventListener('click', (event) => {
       if (event.target === modal) {
           modal.style.display = 'none';
       }
   });

   // Ajustar o evento de mudança no select de dias
   const selectDia = document.getElementById('select-dia');
   selectDia.addEventListener('change', (event) => {
       const diaSelecionado = event.target.value;
       atualizarDiaSelecionado(diaSelecionado);
   });
   }

   async function carregarGraficoDia(dia) {
   dia = dia || sessionStorage.getItem('DIA_ATUAL'); // Usa o dia armazenado caso não seja passado

   if (!dia) {
       console.error('O dia não foi definido.');
       return;
   }

   const selectedTotem = document.getElementById('selectTotem').value;
   const selectedComponent = document.getElementById('selectComp').value;

   try {
       const response = await fetch(`/dashRegressao/diario/${selectedTotem}/${selectedComponent}/${dia}`);
       if (!response.ok) throw new Error('Erro ao buscar dados do dia.');

       const { valoresReais } = await response.json();

       const chartContainer = document.querySelector('#modal-chart');
       chartContainer.innerHTML = ''; // Limpa o gráfico anterior

       const horarios = Array.from({ length: 24 }, (_, i) => `${i}h`); // Horários de 0h a 23h

       // Garante que valoresReais seja um array válido
       const dadosValidos = Array.isArray(valoresReais) && valoresReais.length > 0 ? valoresReais : Array(24).fill(0);

       const options = {
           chart: { type: 'line', height: 300 },
           series: [
               { name: 'Valores Reais', data: dadosValidos }
           ],
           xaxis: {
               categories: horarios,
               title: { text: 'Hora do Dia' }
           },
           yaxis: {
               title: { text: 'Valor do Componente' }
           },
           title: {
               text: `Valores do Dia: ${traduzirDia(dia)}`,
               align: 'center'
           },
           colors: ['#1E90FF'], // Cor do gráfico
           stroke: { curve: 'smooth', width: 2 },
       };

       const chart = new ApexCharts(chartContainer, options);
       chart.render();
   } catch (error) {
       console.error('Erro ao carregar gráfico do dia:', error);

       // Caso haja erro, renderiza um gráfico vazio com uma mensagem
       const chartContainer = document.querySelector('#modal-chart');
       chartContainer.innerHTML = ''; // Limpa o gráfico anterior

       const horarios = Array.from({ length: 24 }, (_, i) => `${i}h`);

       const options = {
           chart: { type: 'line', height: 300 },
           series: [
               { name: 'Valores Reais', data: Array(24).fill(0) }
           ],
           xaxis: {
               categories: horarios,
               title: { text: 'Hora do Dia' }
           },
           yaxis: {
               title: { text: 'Valor do Componente' }
           },
           title: {
               text: `Erro ao carregar os valores para o dia: ${traduzirDia(dia)}`,
               align: 'center'
           },
           colors: ['#FF0000'], // Cor de erro
           stroke: { curve: 'smooth', width: 2 },
       };

       const chart = new ApexCharts(chartContainer, options);
       chart.render();
   }
}


   function atualizarDiaSelecionado(dia) {
       diaAtual = dia;
       sessionStorage.setItem('DIA_ATUAL', dia);
       carregarGraficoDia(dia);
   }

   async function fetchMetrics() {
   const selectedTotem = document.getElementById('selectTotem').value;
   const selectedComponent = document.getElementById('selectComp').value;

   try {
       const response = await fetch(`/dashRegressao/semanal/${selectedTotem}/${selectedComponent}`);
       if (!response.ok) throw new Error('Erro ao buscar dados do servidor.');

       const { semanaAtual, semanaPassada } = await response.json();
       const diasSemana = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

       const valoresAtuais = diasSemana.map(
           (dia) => semanaAtual.find((item) => item.dia_semana === dia)?.componente_avg || 0
       );
       const valoresPassados = diasSemana.map(
           (dia) => semanaPassada.find((item) => item.dia_semana === dia)?.componente_avg || 0
       );

       const previsoes = [];
       for (let i = 0; i < diasSemana.length; i++) {
           const y = valoresPassados.slice(0, i + 1);
           const x = Array.from({ length: i + 1 }, (_, idx) => idx);
           const pontos = x.map((val, idx) => [val, y[idx]]);
           const modelo = regression.linear(pontos);
           previsoes.push(modelo.predict(i)[1]);
       }

       const maiorPrevisao = Math.max(...previsoes);
       const menorPrevisao = Math.min(...previsoes);
       const indiceMaior = previsoes.indexOf(maiorPrevisao);
       const indiceMenor = previsoes.indexOf(menorPrevisao);

       const diaMaiorPrevisao = diasSemana[indiceMaior];
       const diaMenorPrevisao = diasSemana[indiceMenor];

       // Salva os dias com maior e menor previsão no sessionStorage
       sessionStorage.setItem('DIA_MAIOR_PREVISAO', diaMaiorPrevisao);
       sessionStorage.setItem('DIA_MENOR_PREVISAO', diaMenorPrevisao);

       // Atualiza os elementos de maior e menor previsão
       const maiorPrevisaoEl = document.getElementById("maiorPrevisao");
       const menorPrevisaoEl = document.getElementById("menorPrevisao");
       maiorPrevisaoEl.textContent = traduzirDia(diaMaiorPrevisao);
       menorPrevisaoEl.textContent = traduzirDia(diaMenorPrevisao);

       // Adicionar eventos de clique para abrir o modal
       maiorPrevisaoEl.addEventListener('click', () => {
           sessionStorage.setItem('DIA_ATUAL', diaMaiorPrevisao); // Salva o dia atual
           abrirModal(`Detalhes do dia com maior previsão: ${traduzirDia(diaMaiorPrevisao)}`, diaMaiorPrevisao);
       });

       menorPrevisaoEl.addEventListener('click', () => {
           sessionStorage.setItem('DIA_ATUAL', diaMenorPrevisao); // Salva o dia atual
           abrirModal(`Detalhes do dia com menor previsão: ${traduzirDia(diaMenorPrevisao)}`, diaMenorPrevisao);
       });

       atualizarRanking(diasSemana, valoresAtuais, previsoes);
       renderChart1(diasSemana, valoresAtuais, previsoes.map(p => p + 10), previsoes.map(p => p - 10));
       renderChart2(diasSemana, valoresAtuais, previsoes);

   } catch (error) {
       console.error('Erro ao buscar métricas:', error);
   }
}

function atualizarRanking(dias, valoresReais, previsoes) {
   const diasAcima = [];
   const diasAbaixo = [];

   dias.forEach((dia, index) => {
       if (valoresReais[index] > previsoes[index]) {
           diasAcima.push(dia);
       } else if (valoresReais[index] < previsoes[index]) {
           diasAbaixo.push(dia);
       }
   });

   const listaAcima = document.getElementById('diasAcima');
   const listaAbaixo = document.getElementById('diasAbaixo');

   // Limpa o conteúdo anterior
   listaAcima.innerHTML = '';
   listaAbaixo.innerHTML = '';

   // Adiciona os dias "Acima" como botões com eventos
   diasAcima.forEach(dia => {
       const elemento = document.createElement('div');
       elemento.className = 'dia';
       elemento.textContent = traduzirDia(dia);
       elemento.style.cursor = 'pointer';
       elemento.addEventListener('click', () => {
           sessionStorage.setItem('DIA_ATUAL', dia); // Salva o dia atual
           abrirModal(`Detalhes do dia: ${traduzirDia(dia)}`, dia);
       });
       listaAcima.appendChild(elemento);
   });

   // Adiciona os dias "Abaixo" como botões com eventos
   diasAbaixo.forEach(dia => {
       const elemento = document.createElement('div');
       elemento.className = 'dia';
       elemento.textContent = traduzirDia(dia);
       elemento.style.cursor = 'pointer';
       elemento.addEventListener('click', () => {
           sessionStorage.setItem('DIA_ATUAL', dia); // Salva o dia atual
           abrirModal(`Detalhes do dia: ${traduzirDia(dia)}`, dia);
       });
       listaAbaixo.appendChild(elemento);
   });
}


   function renderChart1(dias, valores, previsaoMaxima, previsaoMinima) {
       const selectedComponent = document.getElementById('selectComp').value;
       const chartContainer = document.querySelector("#chart");
       chartContainer.innerHTML = '';

       const options = {
           chart: { type: 'line', height: 290 },
           series: [
               { name: 'Valores Reais', data: valores.map(v => Math.round(v)) },
               { name: 'Previsão Máxima', data: previsaoMaxima.map(v => Math.round(v)) },
               { name: 'Previsão Mínima', data: previsaoMinima.map(v => Math.round(v)) },
               {
                   name: 'Limite (65%)',
                   data: Array(dias.length).fill(65),
               }
           ],
           xaxis: {
               categories: dias.map(traduzirDia),
               labels: { style: { colors: '#000000' } } // Cor para os valores no eixo X
           },
           yaxis: {
               min: 0,
               max: 100,
               labels: {
                   style: { colors: '#000000' }, // Cor para os valores no eixo Y
                   formatter: val => val.toFixed(0)
               }
           },
           stroke: {
               curve: 'smooth',
               width: [3, 3, 3, 2],
               dashArray: [0, 0, 0, 7]
           },
           colors: ['#18204b', '#ff0000', '#1E90FF', '#000000'], // Cores das linhas
           title: {
               text: `Previsão do Percentual Máximo e Mínimo de ${selectedComponent}`,
               align: 'left',
               style: { color: '#000000', fontSize: '17px' } // Cor para o título do gráfico
           },
           legend: {
               labels: { colors: '#000000' }, // Cor para as legendas
               position: 'bottom'
           },
           grid: {
               borderColor: '#000000', // Cor para a grade
               strokeDashArray: 0
           }
       };

       const chart = new ApexCharts(chartContainer, options);
       chart.render();
   }

   function renderChart2(dias, valores, previsoes) {
       const selectedComponent = document.getElementById('selectComp').value;
       const chartContainer2 = document.querySelector("#chart2");
       chartContainer2.innerHTML = '';

       const options = {
           chart: { type: 'line', height: 290, width: 470 },
           series: [
               { name: 'Valores Reais', data: valores.map(v => Math.round(v)) },
               { name: 'Previsão', data: previsoes.map(v => Math.round(v)) },
               {
                   name: 'Limite (65%)',
                   data: Array(dias.length).fill(65),
               }
           ],
           xaxis: {
               categories: dias.map(traduzirDia),
               labels: {
                   style: { colors: '#000000' }, // Cor para os valores no eixo X
                   rotate: -45,
                   hideOverlappingLabels: false
               }
           },
           yaxis: {
               min: 0,
               max: 100,
               labels: {
                   style: { colors: '#000000' }, // Cor para os valores no eixo Y
                   formatter: val => val.toFixed(0)
               }
           },
           stroke: {
               curve: 'smooth',
               width: [3, 3, 2],
               dashArray: [0, 0, 7]
           },
           colors: ['#1E90FF', '#18204b', '#000000'], // Cores das linhas
           title: {
               text: `Previsão do Percentual de ${selectedComponent}`,
               align: 'left',
               style: { color: '#000000', fontSize: '17px' } // Cor para o título do gráfico
           },
           legend: {
               labels: { colors: '#000000' }, // Cor para as legendas
               position: 'bottom'
           },
           grid: {
               borderColor: '#000000', // Cor para a grade
               strokeDashArray: 0
           }
       };

       const chart2 = new ApexCharts(chartContainer2, options);
       chart2.render();
   }

   function traduzirDia(dia) {
       const dias = {
           Sunday: 'Domingo',
           Monday: 'Segunda',
           Tuesday: 'Terça',
           Wednesday: 'Quarta',
           Thursday: 'Quinta',
           Friday: 'Sexta',
           Saturday: 'Sábado'
       };
       return dias[dia] || dia;
   }

   async function fetchRanking() {
       try {
           const response = await fetch('/dashRegressao/ranking');
           if (!response.ok) throw new Error('Erro ao buscar ranking.');

           const ranking = await response.json();

           for (let i = 0; i < ranking.length; i++) {
               document.getElementById(`posicao${i + 1}`).textContent = `${i + 1}°`;
               document.getElementById(`nome${i + 1}`).textContent =
                   `Totem ${ranking[i].totem} - ${ranking[i].componente}: ${ranking[i].valor.toFixed(2)}`;
           }

           const { totem, componente } = ranking[0];
           document.getElementById('selectTotem').value = totem;
           document.getElementById('selectComp').value = mapComponentName(componente);

           fetchMetrics();
       } catch (error) {
           console.error('Erro ao buscar ranking:', error);
       }
   }

   function mapComponentName(componente) {
       const mapping = {
           'CPU': 'Cpu',
           'RAM': 'Ram',
           'Disco': 'Disco',
       };
       return mapping[componente] || componente;
   }

   document.addEventListener('DOMContentLoaded', fetchRanking);
   document.addEventListener("DOMContentLoaded", fetchMetrics);
   document.addEventListener('DOMContentLoaded', configurarModal);

</script>

</html>