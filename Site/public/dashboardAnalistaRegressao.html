<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Métricas Gerente - GateWatch</title>
    <link rel="stylesheet" href="./CSS/styleRegressao.css">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>

<body>

    <div class="conteudoPagina">
        <div class="boxLateral">
            <div class="boxIdentificacao">
                <h1 class="fonte_perfil" id="nome_perfil"></h1>
                <h3>ANALISTA DE DADOS</h3>
            </div>
            <div class="boxOpcoes">
                <a href="index.html">
                    <div class="box">HOME</div>
                </a>
                <a href="dashboardAnalistaMetricas.html">
                    <div class="box">DASHBOARD</div>
                </a>
                <a href="dashboardAnalistaRegressao.html">
                    <div class="box" style="background-color: #41446877;">PREVISÕES</div>
                </a>
            </div>
            <a href="cadastro.html">
                <div class="boxSair">SAIR</div>
            </a>
        </div>
        <div class="conteudoMetricas">
            <div class="boxTitulo">
                <div class="selecionarTotem">
                    <select id="selectTotem" onchange="fetchMetrics()">
                        <option selected disabled>Selecione um Totem</option>
                        <option>TOTEM 1</option>
                        <option>TOTEM 2</option>
                        <option>TOTEM 3</option>
                    </select>
                    <select id="selectComp" onchange="fetchMetrics()">
                        <option selected disabled>Selecione um Componente</option>
                        <option>CPU</option>
                        <option>RAM</option>
                        <option>DISCO</option>
                    </select>
                </div>
            </div>
            <div class="boxConteudo">
                <div class="boxComponentes">
                    <div class="ranking">
                        <h3>Ranking de Semanas com Maiores Previsões</h3>
                        <div class="ranking-grid">
                            <div class="ranking-posicao">1°</div>
                            <div class="ranking-nome">Totem 1 - Semana 3</div>
                            <div class="ranking-posicao">2°</div>
                            <div class="ranking-nome">Totem 1 - Semana 1</div>
                            <div class="ranking-posicao">3°</div>
                            <div class="ranking-nome">Totem 1 - Semana 4</div>
                        </div>
                    </div>
                    <div class="boxMedias">
                        <div class="box1">
                            <h4>Dia com maior previsão</h4>
                            <p>Quarta</p>
                        </div>
                        <div class="box2">
                            <h4>Dia com menor previsão</h4>
                            <p>Terça</p>
                        </div>
                    </div>
                    <div class="boxGrafico">
                        <div class="grafico">
                            <div id="chart"></div>
                        </div>
                    </div>
                </div>
                <div class="boxAlertas">
                    <div class="boxRankingAlertas">

                    </div>
                    <div class="grafico2">
                        <div id="chart2" style="margin-top: 0.8vh;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>

</html>

<script>
      async function fetchMetrics() {
        try {
            const selectedTotem = document.getElementById('selectTotem').value.replace('TOTEM ', '');
            const selectedComponent = document.getElementById('selectComp').value;

            if (!selectedTotem || !selectedComponent) {
                alert('Por favor, selecione todos os campos.');
                return;
            }

            const response = await fetch(`/dashRegressao/semanal?totem=${selectedTotem}&componente=${selectedComponent}`);
            if (!response.ok) throw new Error('Erro ao buscar dados do servidor.');

            const data = await response.json();

            if (!data.metrics || data.metrics.length === 0) {
                alert('Nenhum dado disponível para o componente e totem selecionados.');
                return;
            }

            if (data.missingDays && data.missingDays.length > 0) {
                alert(`Dados ausentes para os dias: ${data.missingDays.join(', ')}`);
            }

            const dias = data.metrics.map(d => d.dia_semana);
            const componentData = data.metrics.map(d => d.valor);

            renderChart1(dias, componentData);
            renderChart2(dias, componentData);
        } catch (error) {
            console.error("Erro ao buscar métricas semanais:", error);
        }
    }

    function renderChart1(dias, componentData) {

        const chartContainer = document.querySelector("#chart");
        if (chartContainer.children.length) {
            chartContainer.innerHTML = '';
        }

        const options = {
            chart: {
                type: 'line',
                height: 270
            },
            series: [
                { name: 'Componente Escolhido', data: componentData },
                { name: 'Limite Componente', data: Array(dias.length).fill(65) }
            ],
            xaxis: { categories: dias, labels: { style: { colors: '#ffffff' } } },
            yaxis: { min: 0, max: 100, labels: { style: { colors: '#ffffff' } } },
            stroke: { curve: 'smooth', width: [4, 3], dashArray: [0, 5] },
            colors: ['#1e81b0', '#00FF00'],
            title: { text: 'Previsão do Percentual', align: 'left', style: { color: '#ffffff', fontSize: '17px' } },
            legend: { labels: { colors: '#ffffff' }, position: 'bottom' }
        };

        const chart = new ApexCharts(chartContainer, options);
        chart.render();
    }

    function renderChart2(dias, componentData) {

        const chartContainer2 = document.querySelector("#chart2");
        if (chartContainer2.children.length) {
            chartContainer2.innerHTML = '';
        }

        const options = {
            chart: {
                type: 'line',
                height: 280,
                width: 470
            },
            series: [
                { name: 'Componente Escolhido', data: componentData },
                { name: 'Limite Componente', data: Array(dias.length).fill(65) }
            ],
            xaxis: { categories: dias, labels: { style: { colors: '#ffffff' } } },
            yaxis: { min: 0, max: 100, labels: { style: { colors: '#ffffff' } } },
            stroke: { curve: 'smooth', width: [4, 3], dashArray: [0, 5] },
            colors: ['#1e81b0', '#00FF00'],
            title: { text: 'Previsão do Percentual', align: 'left', style: { color: '#ffffff', fontSize: '17px' } },
            legend: { labels: { colors: '#ffffff' }, position: 'bottom' }
        };

        const chart2 = new ApexCharts(chartContainer2, options);
        chart2.render();
    }

    document.addEventListener("DOMContentLoaded", () => {
        document.getElementById('selectComp').value = "CPU";
        document.getElementById('selectTotem').value = "TOTEM 1";
        fetchMetrics();
    });

</script>