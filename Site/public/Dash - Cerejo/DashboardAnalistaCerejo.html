<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Métricas Analista - GateWatch</title>
    <link rel="stylesheet" href="../CSS/styleDashboards.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-wordcloud"></script>
</head>

<body>
    <div class="conteudoPagina">
        <div class="boxLateral">
            <div class="boxIdentificacao">
                <h1 class="fonte_perfil" id="nome_perfil"></h1>
                <h3>ANALISTA DE DADOS</h3>
            </div>
            <div class="boxOpcoes">
                <a href="index.html">
                    <div class="box">HOME</div>
                </a>
                <a href="dashboardAnalistaMetricas.html">
                    <div class="box" style="background-color: #41446877;">DASHBOARD</div>
                </a>
                <a href="dashboardAnalistaRegressao.html">
                    <div class="box">PREVISÕES</div>
                </a>
            </div>
            <a href="cadastro.html">
                <div class="boxSair">SAIR</div>
            </a>
        </div>

        <div class="mainContent">
            <div class="header">
                <h1>ANÁLISE DE PROCESSOS</h1>
                <select name="" id="totemSelect">
                    <option value="toten1">TÓTEM 1</option>
                    <option value="toten2">TÓTEM 2</option>
                    <option value="toten3">TÓTEM 3</option>
                </select>
            </div>
            <div class="blocoTop">
                <div class="nuvem">
                    <div class="titulo1">
                        <div class="bar"></div>Nuvem de processos
                    </div>
                    <div class="wordcloud">
                        <canvas id="chart3" width="527" height="500"
                            style="display: block;box-sizing: border-box;height: 400px;width: 400px;"></canvas>
                    </div>
                </div>

                <div class="frequencia">
                    <div class="titulo2">
                        <div class="bar"></div>Frequência de processos
                    </div>
                    <div id="chart2"></div>
                </div>
            </div>

            <div class="blocoBottom">
                <div class="projecao">
                    <div class="titulo3">
                        <div class="bar"></div>Projeção da execução de processos
                    </div>
                    <canvas id="chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Fetch e atualização do Scatter Chart
        async function updateScatterChart() {
            try {
                const response = await fetch('/dashCerejo/frequencia');
                const data = await response.json();
    
                const scatterData = data.map(item => ({
                    x: item.nomeProcesso,
                    y: item.frequencia
                }));
    
                const ctxScatter = document.getElementById('chart').getContext('2d');
                new Chart(ctxScatter, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: 'Frequência de Processos',
                            data: scatterData,
                            backgroundColor: 'rgb(255, 99, 132)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: 'category',
                                position: 'bottom',
                                title: {
                                    display: true,
                                    text: 'Processos'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Frequência'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Erro ao carregar dados do Scatter Chart:', error);
            }
        }
    
        // Fetch e atualização do Apex Bar Chart
        async function updateApexChart() {
            try {
                const response = await fetch('/dashCerejo/frequencia');
                const data = await response.json();
    
                const seriesData = data.map(item => ({
                    x: item.nomeProcesso,
                    y: item.frequencia,
                    goals: [{
                        name: 'Expected',
                        value: item.frequencia + 50, // Exemplo de valor esperado
                        strokeHeight: 5,
                        strokeColor: '#775DD0'
                    }]
                }));
    
                const apexOptions = {
                    series: [{
                        name: 'Frequência Atual',
                        data: seriesData
                    }],
                    chart: {
                        height: 400,
                        type: 'bar'
                    },
                    plotOptions: {
                        bar: {
                            columnWidth: '60%'
                        }
                    },
                    colors: ['#00E396'],
                    legend: {
                        show: true,
                        customLegendItems: ['Frequência Atual', 'Esperado'],
                        markers: {
                            fillColors: ['#00E396', '#775DD0']
                        }
                    }
                };
    
                const apexChart = new ApexCharts(document.querySelector("#chart2"), apexOptions);
                apexChart.render();
            } catch (error) {
                console.error('Erro ao carregar dados do Apex Bar Chart:', error);
            }
        }
    
        // Fetch e atualização do WordCloud Chart
        async function updateWordCloudChart() {
        try {
            const response = await fetch('/dashCerejo/cpu');
            const data = await response.json();

            // Validando e limitando os dados
            const labels = data.slice(0, 20).map(item => item.nomeProcesso); // Limite de 20 palavras
            const weights = data.slice(0, 20).map(item => Math.max(parseFloat(item.total_cpu), 1)); // Evitar valores muito pequenos ou negativos

            // Criando o gráfico WordCloud
            const ctxWordCloud = document.getElementById('chart3').getContext('2d');
            const wordCloudChart = new Chart(ctxWordCloud, {
                type: 'wordCloud',
                data: {
                    labels,
                    datasets: [{
                        label: 'Uso de CPU',
                        data: weights
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    layout: {
                        padding: { top: 10, bottom: 10 }
                    }
                }
            });

            wordCloudChart.update();
        } catch (error) {
            console.error('Erro ao carregar dados do WordCloud Chart:', error);
        }
    }
    
        // Chamada das funções de atualização
        updateScatterChart();
        updateApexChart();
        updateWordCloudChart();
    </script>
        

</body>

</html>