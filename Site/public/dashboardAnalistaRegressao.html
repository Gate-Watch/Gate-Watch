<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Métricas Gerente - GateWatch</title>
    <link rel="stylesheet" href="./CSS/styleRegressao.css">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdn.jsdelivr.net/npm/regression"></script>
</head>

<body>

    <div class="conteudoPagina">
        <div class="boxLateral">
            <div class="boxIdentificacao">
                <h1 class="fonte_perfil" id="nome_perfil">Usuário</h1>
                <h3>ANALISTA DE DADOS</h3>
            </div>
            <div class="boxOpcoes">
                <a href="index.html">
                    <div class="box">HOME</div>
                </a>
                <a href="dashboardAnalistaMetricas.html">
                    <div class="box">DASHBOARD</div>
                </a>
                <a href="dashboardAnalistaRegressao.html">
                    <div class="box" style="background-color: #41446877;">PREVISÕES</div>
                </a>
            </div>
            <a href="cadastro.html">
                <div class="boxSair">SAIR</div>
            </a>
        </div>
        <div class="conteudoMetricas">
            <div class="boxTitulo">
                <div class="selecionarTotem">
                    <select id="selectTotem" onchange="fetchMetrics()">
                        <option value="1" selected>Totem 1</option>
                        <option value="2">Totem 2</option>
                        <option value="3">Totem 3</option>
                    </select>
                    <select id="selectComp" onchange="fetchMetrics()">
                        <option value="Cpu" selected>CPU</option>
                        <option value="Ram">RAM</option>
                        <option value="Disco">DISCO</option>
                    </select>
                </div>
            </div>
            <div class="boxConteudo">
                <div class="boxComponentes">
                    <div class="ranking">
                        <h3>Ranking de Totens com Maiores Previsões na Semana Atual</h3>
                        <div class="ranking-grid" id="ranking">
                            <div class="ranking-posicao">1°</div>
                            <div class="ranking-nome">Carregando...</div>
                        </div>
                    </div>
                    <div class="boxMedias">
                        <div class="box1">
                            <h4>Dia com maior previsão</h4>
                            <p id="maiorPrevisao">Carregando...</p>
                        </div>
                        <div class="box2">
                            <h4>Dia com menor previsão</h4>
                            <p id="menorPrevisao">Carregando...</p>
                        </div>
                    </div>
                    <div class="boxGrafico">
                        <div class="grafico">
                            <div id="chart" style="margin-top: 0vh;"></div>
                        </div>
                    </div>
                </div>
                <div class="boxAlertas">
                    <div class="boxRankingAlertas">
                        <h3 style="text-align: center;">Dias Acima e Abaixo da Previsão</h3>
                        <div class="linha"></div>
                        <div class="conteudo-ranking">
                            <div class="acima">
                                <h4>Dias Acima:</h4>
                                <ul id="diasAcima"></ul>
                            </div>
                            <div class="abaixo">
                                <h4>Dias Abaixo:</h4>
                                <ul id="diasAbaixo"></ul>
                            </div>
                        </div>
                    </div>
                    
                    
                    <div class="grafico2">
                        <div id="chart2" style="margin-top: 1vh;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>

<script>
    // Atualiza o nome do usuário no perfil
    nome_perfil.innerHTML = sessionStorage.NOME_USUARIO;

    // Função para buscar métricas
    async function fetchMetrics() {
    const selectedTotem = document.getElementById('selectTotem').value;
    const selectedComponent = document.getElementById('selectComp').value;

    try {
        const response = await fetch(`/dashRegressao/semanal/${selectedTotem}/${selectedComponent}`);
        if (!response.ok) throw new Error('Erro ao buscar dados do servidor.');

        const { semanaAtual, semanaPassada } = await response.json();

        const diasSemana = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

        // Processar dados semanais (primeiro array)
        const valoresAtuais = diasSemana.map(
            (dia) => semanaAtual.find((item) => item.dia_semana === dia)?.componente_avg || 0
        );

        // Processar dados da semana passada (segundo array)
        const valoresPassados = diasSemana.map(
            (dia) => semanaPassada.find((item) => item.dia_semana === dia)?.componente_avg || 0
        );

        // Regressão linear para cada dia
        const previsoes = [];

        for (let i = 0; i < diasSemana.length; i++) {
            const y = valoresPassados.slice(0, i + 1); // Valores da semana passada até o dia 'i'
            const x = Array.from({ length: i + 1 }, (_, idx) => idx); // Indices 0, 1, 2, ..., i
            const pontos = x.map((val, idx) => [val, y[idx]]);
            const modelo = regression.linear(pontos);

            previsoes.push(modelo.predict(i)[1]); // Previsão central
        }

        // Encontrar o dia com maior e menor previsão
        const maiorPrevisao = Math.max(...previsoes);
        const menorPrevisao = Math.min(...previsoes);
        const indiceMaior = previsoes.indexOf(maiorPrevisao);
        const indiceMenor = previsoes.indexOf(menorPrevisao);

        const diaMaiorPrevisao = traduzirDia(diasSemana[indiceMaior]);
        const diaMenorPrevisao = traduzirDia(diasSemana[indiceMenor]);

        // Atualizar as divs
        document.getElementById("maiorPrevisao").textContent = diaMaiorPrevisao;
        document.getElementById("menorPrevisao").textContent = diaMenorPrevisao;

        // Atualizar a lista de dias acima/abaixo
        atualizarRanking(diasSemana, valoresAtuais, previsoes);

        // Renderizar os gráficos
        renderChart1(diasSemana, valoresAtuais, previsoes.map(p => p + 10), previsoes.map(p => p - 10));
        renderChart2(diasSemana, valoresAtuais, previsoes);
    } catch (error) {
        console.error('Erro ao buscar métricas:', error);
    }
}



function atualizarRanking(dias, valoresReais, previsoes) {
    const diasAcima = [];
    const diasAbaixo = [];

    dias.forEach((dia, index) => {
        if (valoresReais[index] > previsoes[index]) {
            diasAcima.push(traduzirDia(dia));
        } else if (valoresReais[index] < previsoes[index]) {
            diasAbaixo.push(traduzirDia(dia));
        }
    });

    // Atualizar o HTML
    const listaAcima = document.getElementById('diasAcima');
    const listaAbaixo = document.getElementById('diasAbaixo');

    listaAcima.innerHTML = diasAcima.map(dia => `<li>${dia}</li>`).join('');
    listaAbaixo.innerHTML = diasAbaixo.map(dia => `<li>${dia}</li>`).join('');
}


    // Função para renderizar o gráfico 1
    function renderChart1(dias, valores, previsaoMaxima, previsaoMinima) {
        const selectedComponent = document.getElementById('selectComp').value;
        const chartContainer = document.querySelector("#chart");
        chartContainer.innerHTML = ''; // Limpar o gráfico anterior

        const options = {
            chart: { type: 'line', height: 292 },
            series: [
                { name: 'Valores Reais', data: valores.map(v => Math.round(v)) },
                { name: 'Previsão Máxima', data: previsaoMaxima.map(v => Math.round(v)) },
                { name: 'Previsão Mínima', data: previsaoMinima.map(v => Math.round(v)) },
                {
                    name: 'Limite (65%)',
                    data: Array(dias.length).fill(65),
                }
            ],
            xaxis: {
                categories: dias.map(traduzirDia),
                labels: { style: { colors: '#ffffff' } }
            },
            yaxis: {
                min: 0,
                max: 100,
                labels: {
                    style: { colors: '#ffffff' },
                    formatter: val => val.toFixed(0)
                }
            },
            stroke: {
                curve: 'smooth',
                width: [3, 3, 3, 2], // Define espessura para cada linha
                dashArray: [0, 0, 0, 7] // Define apenas a última série como pontilhada
            },
            colors: ['#18204b', '#ff0000', '#1E90FF', '#00ff00'], // Cores das séries
            title: {
                text: `Previsão do Percentual Máximo e Mínimo de ${selectedComponent}`,
                align: 'left',
                style: { color: '#ffffff', fontSize: '17px' }
            },
            legend: {
                labels: { colors: '#ffffff' },
                position: 'bottom'
            },
            grid: {
                borderColor: '#ffffff',
                strokeDashArray: 0
            }
        };

        const chart = new ApexCharts(chartContainer, options);
        chart.render();
    }

    // Função para renderizar o gráfico 2
    function renderChart2(dias, valores, previsoes) {
        const selectedComponent = document.getElementById('selectComp').value;
        const chartContainer2 = document.querySelector("#chart2");
        chartContainer2.innerHTML = ''; // Limpar o gráfico anterior

        const options = {
            chart: { type: 'line', height: 295, width: 470 },
            series: [
                { name: 'Valores Reais', data: valores.map(v => Math.round(v)) },
                { name: 'Previsão', data: previsoes.map(v => Math.round(v)) },
                {
                    name: 'Limite (65%)',
                    data: Array(dias.length).fill(65),
                }
            ],
            xaxis: {
                categories: dias.map(traduzirDia),
                labels: {
                    style: { colors: '#ffffff' },
                    rotate: -45,
                    hideOverlappingLabels: false
                }
            },
            yaxis: {
                min: 0,
                max: 100,
                labels: {
                    style: { colors: '#ffffff' },
                    formatter: val => val.toFixed(0)
                }
            },
            stroke: {
                curve: 'smooth',
                width: [3, 3, 2], // Espessura das linhas
                dashArray: [0, 0, 7] // Última série pontilhada
            },
            colors: ['#1E90FF', '#18204b', '#00ff00'], // Cores das séries
            title: {
                text: `Previsão do Percentual de ${selectedComponent}`,
                align: 'left',
                style: { color: '#ffffff', fontSize: '17px' }
            },
            legend: {
                labels: { colors: '#ffffff' },
                position: 'bottom'
            },
            grid: {
                borderColor: '#ffffff',
                strokeDashArray: 0
            }
        };

        const chart2 = new ApexCharts(chartContainer2, options);
        chart2.render();
    }

    // Função para traduzir os dias da semana
    function traduzirDia(dia) {
        const dias = {
            Sunday: 'Domingo',
            Monday: 'Segunda',
            Tuesday: 'Terça',
            Wednesday: 'Quarta',
            Thursday: 'Quinta',
            Friday: 'Sexta',
            Saturday: 'Sábado'
        };
        return dias[dia] || dia;
    }

    // Espera o DOM carregar para executar a função fetchMetrics
    document.addEventListener("DOMContentLoaded", fetchMetrics);
</script>



</html>